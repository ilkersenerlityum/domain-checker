name: Check Domains

on:
  schedule:
    - cron: "*/1 * * * *"
  workflow_dispatch:

jobs:
  check_domains:
    runs-on: ubuntu-latest

    steps:
      - name: Depoyu Kopyala
        uses: actions/checkout@v3

      - name: Node.js Kur ve Paketleri YÃ¼kle
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
        run: npm ci

      - name: Testleri Ã‡alÄ±ÅŸtÄ±r
        run: npx cypress run || true

      - name: HatalÄ± Domainler Ä°Ã§in Ekran GÃ¶rÃ¼ntÃ¼lerini YÃ¼kle ve Google Chat'e Bildir
        run: |
          mkdir -p screenshots_flat

          if [ -d "cypress/screenshots" ]; then
            find cypress/screenshots -type f -name "*.png" -exec cp {} screenshots_flat/ \;
          else
            echo "ğŸ“‚ 'cypress/screenshots' klasÃ¶rÃ¼ yok, screenshot bulunamadÄ±."
          fi


          uploaded_links=()
          for img in screenshots_flat/*.png; do
            response=$(curl -s --request POST "https://api.imgur.com/3/image" \
              --header "Authorization: Client-ID ${{ secrets.IMGUR_CLIENT_ID }}" \
              --form "image=@$img")

            
            link=$(echo "$response" | jq -r '.data.link')
            uploaded_links+=("$link")
          done

          msg="âš ï¸ **Sunucu SaÄŸlÄ±k KontrolÃ¼**\n"

          if [ ${#uploaded_links[@]} -gt 0 ]; then
            msg+="\nğŸ–¼ï¸ **HatalÄ±/OluÅŸmayan Sayfalar (Screenshot):**\n"
            for link in "${uploaded_links[@]}"; do
              msg+="$link\n"
            done
          else
            msg+="\nâœ… Hata veya ekran gÃ¶rÃ¼ntÃ¼sÃ¼ bulunamadÄ±."
          fi

          curl -X POST "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg text "$msg" '{ text: $text }')"
